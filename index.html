<div style="max-width: 400px; margin: auto; direction: rtl; font-family: sans-serif;">
  <h3>ğŸ›Œ Ø®ÙˆØ§Ø¨ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</h3>
  <textarea id="dreamText" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø®ÙˆØ§Ø¨ Ø¯ÛŒØ¯Ù… Ú©Ù‡ Ø¯Ø± Ø¢Ø³Ù…Ø§Ù† Ù¾Ø±ÙˆØ§Ø² Ù…ÛŒâ€ŒÚ©Ø±Ø¯Ù…..." rows="5" style="width: 100%; padding: 8px;"></textarea>
  <button onclick="submitDream()" style="margin-top: 10px; padding: 8px 16px;">Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ø¨</button>
  <div id="result" style="margin-top: 20px; background: #f5f5f5; padding: 10px;"></div>
</div>

<script>
  async function submitDream() {
    const dream = document.getElementById("dreamText").value;
    if (!dream.trim()) {
      alert("Ù„Ø·ÙØ§Ù‹ Ø®ÙˆØ§Ø¨ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
      return;
    }

    const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9pZm9td2V3bWdta2lzc3hvb2x0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDk4OTYsImV4cCI6MjA2MjYyNTg5Nn0.2WacohibeqsuM2UOgbPkY1qswTA3nDBPqfIttBo0U-k";

    // Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±Ø¬ Ø®ÙˆØ§Ø¨ Ø¯Ø± Ø¬Ø¯ÙˆÙ„
    const insertRes = await fetch("https://oifomwewmgmkissxoolt.supabase.co/rest/v1/dreams", {
      method: "POST",
      headers: {
        "apikey": apiKey,
        "Authorization": "Bearer " + apiKey,
        "Content-Type": "application/json",
        "Prefer": "return=representation"
      },
      body: JSON.stringify({ dream_text: dream })
    });

    const insertData = await insertRes.json();
    if (!insertRes.ok || !insertData[0]?.id) {
      document.getElementById("result").innerText = "âŒ Ø¯Ø±Ø¬ Ø®ÙˆØ§Ø¨ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.";
      console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±Ø¬ Ø®ÙˆØ§Ø¨:", insertData);
      return;
    }

    // Ù…Ø±Ø­Ù„Ù‡ 2: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ ØªØ§Ø¨Ø¹ ØªÙØ³ÛŒØ± Ø®ÙˆØ§Ø¨
    const fxRes = await fetch("https://oifomwewmgmkissxoolt.supabase.co/functions/v1/interpret-dream", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + apiKey
      },
      body: JSON.stringify({ dream })
    });

    const fxData = await fxRes.json();
    if (!fxRes.ok) {
      document.getElementById("result").innerText = "âŒ ØªØ¹Ø¨ÛŒØ± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.";
      console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ§Ø¨Ø¹ ØªØ¹Ø¨ÛŒØ±:", fxData);
      return;
    }

    document.getElementById("result").innerText = "âœ… ØªØ¹Ø¨ÛŒØ± Ø®ÙˆØ§Ø¨: " + fxData.interpretation;
  }
</script>
